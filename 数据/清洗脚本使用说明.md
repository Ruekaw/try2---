# DWTS 数据清洗脚本使用说明

对应脚本：`数据/clean_dwts.py`

本说明面向 2026 MCM C 题数据（DWTS），解释如何运行清洗脚本、输出文件含义，以及各输出表字段（列名）解释与可能取值。

---

## 1. 运行环境与依赖

- Python 3.x
- 依赖包：`pandas`、`numpy`

> 注意：如果你用的是 Anaconda base 环境且遇到 `NumPy 2.x` 与二进制扩展不兼容（例如 pandas/pyarrow）的问题，建议直接使用你已配置好的 `mcm_env` 环境运行。

---

## 2. 常用启动命令

### 2.1 推荐（mcm_env）

在项目根目录运行：

```powershell
D:/Anaconda/envs/mcm_env/python.exe 数据/clean_dwts.py --input "数据/source/3-27赛季（百分比结合法）.csv" "数据/source/剩下赛季（排名结合法）.csv" --outdir outputs
```

### 2.2 参数说明

- `--input`：一个或多个输入 CSV 路径（可以同时传入两份数据源，脚本会自动合并）
- `--outdir`：输出目录（不存在会自动创建）
- `--allow-bonus`（可选）：允许“超出范围”的评委分数参与计算（仍会标注 out-of-range）。
	- 当前脚本默认认为单个评委分数合法范围为 **[1, 20]**（0 分用于“缺席/淘汰后不再出场”的编码）
- `--age-overrides` / `--industry-overrides`（可选）：提供手工纠错表

---

## 3. 输出文件总览（outputs/）

脚本会在输出目录生成以下文件：

- `dwts_long_clean.csv`：核心长表（选手-赛季-周）+ 特征工程
- `dwts_season_summary.csv`：赛季层面汇总（选手-赛季）
- `dwts_partner_summary.csv`：舞伴（职业舞者）全局汇总
- `dwts_partner_summary_prior.csv`：舞伴“仅使用历史赛季”的无泄露特征
- `dwts_quality_report.csv`：数据质量/一致性检查报告（metric-value）
- `dwts_excluded_from_inference.csv`：建议从“粉丝投票反推”中排除的行（退赛等）
- `dwts_zero_score_conflicts.csv`：0 分与结果文本冲突的疑似异常行（用于人工复核）

---

## 4. 核心概念（脚本约定）

### 4.1 0 分的含义

- 数据说明里：被淘汰/退赛后的后续周会被记录为 0 分。
- 脚本将 **“全 0”** 视作“该周不在场/不表演”（`is_present=False`）。

### 4.2 N/A 的含义

- `N/A` 表示结构性缺失（例如当周只有 3 位评委，judge4 为 N/A；或该赛季没有那一周）。

### 4.3 决赛周（Finale Week）

- `season_final_week`：该赛季的最后一周（week 最大值）。
- `final_week_n_performers`：决赛周实际“有表演得分”的人数（`is_present=True` 的人数）。
	- 这很关键，因为有些赛季决赛周只剩 2 人表演（第三名在决赛周之前就已确定）。

---

## 5. 表：dwts_long_clean.csv（核心长表）

粒度：**一行 = 某选手在某赛季的某一周（season-week）**。

下面按“字段分组”解释列名与取值。

### 5.1 身份与基本信息

- `celebrity_name`：明星姓名（字符串）
- `ballroom_partner`：职业舞者姓名（字符串）
- `celebrity_industry`：原始行业字段（字符串，原始分类较杂）
- `celebrity_homestate`：原始州字段（字符串，可空）
- `celebrity_homecountry/region`：原始国家/地区字段（字符串，可空）
- `celebrity_age_during_season`：该季年龄（数值，可空）
- `season`：赛季编号（整数）
- `week`：周编号（整数）
- `results`：赛季最终结果文本（字符串，如 `1st Place` / `Eliminated Week 5` / `Withdrew`）
- `placement`：最终名次（整数，1 为冠军）
- `_source_file`：来自哪个输入文件（字符串）

### 5.2 评委分（清洗后 / 原始）

按评委编号展开（最多 4 位）：

- `judge{j}_score`：清洗后该评委分数（数值或 NaN）
- `judge{j}_score_raw`：原始该评委分数（数值或 NaN）
- `judge{j}_out_of_range`：是否超出允许范围（布尔）

其中：

- 合法范围默认是单评委分数 **1–20**（可包含小数）。
- `0` 表示缺席/淘汰后不表演（不是“真实 0 分舞蹈”）。

### 5.3 评委分完整性与在场标记

- `n_judges_reported`：清洗后有记录的评委数量（含 0，不含 NaN）
- `n_judges_present`：当周实际有分（非 0 且非 NaN）的评委数量
- `n_judges_reported_raw`：原始列中有记录的评委数量
- `has_partial_na_raw`：原始评委分是否“部分缺失”（有些 NaN，有些非 NaN）

- `is_all_na`：该行评委分是否全为 NaN（结构性缺失）
- `is_all_zero`：该行评委分是否全为 0（且不是全 NaN）
- `is_present`：当周是否“有表演得分”（非结构性缺失且非全 0）

### 5.4 结果类型解析与冲突检查

- `result_type`：对 `results` 的结构化解析（字符串）
	- 可能取值：`winner` / `finalist` / `eliminated` / `withdrew` / `unknown`
- `is_withdrew_result`：是否从 results 判断为退赛（布尔）

- `zero_score_conflict`：0 分但结果看起来仍在赛的异常标记（布尔）
	- 该字段用于 QA 复核；脚本已对“2 人决赛导致第三名决赛周不出场”等情况做了排除。

### 5.5 周得分汇总与标准化

- `week_total_score`：该周评委总分（清洗后；0 会被当作缺席不计入求和）
- `week_total_score_raw`：该周评委总分（原始）
- `week_avg_score`：该周平均每评委得分（按 `n_judges_present` 平均）
- `week_max_possible`：该周最高可能总分（`n_judges_present * 10`）
- `week_score_percentage`：该周得分占最高可能的比例（`week_total_score / week_max_possible`）

### 5.6 组合方法（Percent / Rank）

- `combine_method`：脚本按赛季给出的“节目大概率使用的结合方法”（字符串）
	- `percent`：第 3–27 季
	- `rank`：其他季（含第 1–2、28–34）

### 5.7 周内相对表现特征（用于建模）

只对 `is_present==True` 的行计算：

- `week_score_rank`：该周评委总分名次（1=最好）
- `week_score_share`：该周评委总分占当周总和的比例
- `week_score_rank_discrepancy`：当周评委名次 - 最终名次（数值，正值表示“当周评委排名更差但最终名次更好”）

### 5.8 决赛周/赛季末逻辑（重点）

- `season_final_week`：赛季最后一周（整数）
- `final_week`：赛季最后一周（同义字段，历史兼容）
- `is_final_week`：是否为决赛周（布尔）

- `final_week_n_performers`：决赛周实际有得分的选手数（整数）
- `expected_to_perform_in_finale`：根据 `placement` 和 `final_week_n_performers` 推断该选手是否“应该”在决赛周出场（布尔）
	- 例如决赛周只有 2 人表演，则 `placement` 为 1/2 的选手为 True，3 及以后为 False

- `last_week_scored`：该选手在该赛季最后一次 `is_present=True` 的周（整数，可空）
- `expected_last_week`：脚本推断该选手“应视作仍在赛”的最后一周（整数，可空）
- `is_competing_week`：该周是否属于“仍在赛”的周（布尔）
- `is_gap_week`：该周是否为“中途缺席一周但后续回归”的空档周（布尔）
- `is_missing_finale_scores`：该周是否为“应出场的决赛周但分数缺失/全 0”的情况（布尔）

### 5.9 无淘汰/双淘汰周标记

- `n_active`：该周仍在赛人数（按 `is_competing_week` 统计）
- `is_no_elimination`：由人数变化推断该周后没有淘汰（布尔）
- `is_double_elimination`：由人数变化推断下一周人数减少 ≥2（布尔）
- `is_no_elim_from_results`：从 results 文本中匹配“无淘汰”字样（布尔）
- `is_no_elimination_any`：两种方法的并集（布尔）

### 5.10 退赛后处理（用于投票反推排除）

- `weeks_since_exit`：从最后一次出场周起过了几周（数值，可空）
- `exclude_from_fan_vote_inference`：建议从粉丝投票反推中排除（布尔）

### 5.11 文本/人口统计特征（清洗后）

- `celebrity_industry_clean`：行业粗分类（字符串）
	- 可能取值：`Athlete` / `Musician` / `Actor` / `Model` / `Politician` / `Reality TV Star` / `TV/Host` / `Other`
- `celebrity_homecountry_clean`：规范化国家/地区（字符串；美国统一为 `United States`）
- `celebrity_homestate_clean`：规范化州名称（字符串）
- `celebrity_homestate_abbr`：州缩写（字符串，如 `CA`；非美国或缺失则 NaN）
- `is_foreign`：是否非美国（布尔）
- `celebrity_age_raw`：原始年龄备份（数值）
- `age_outlier`：年龄是否明显异常（布尔）

### 5.12 退赛/淘汰周文本解析一致性

- `is_withdrawn`：results 文本是否包含 Withdrew（布尔）
- `is_withdrawn_inferred`：是否推断为“异常缺失导致疑似退赛”（布尔）
- `exit_week_from_results`：从 results 抽取的退出周（整数，可空）
- `computed_last_week`：从 `is_present` 计算的最后出场周（整数，可空）
- `exit_week_mismatch`：两者是否不一致（布尔）

### 5.13 舞伴（职业舞者）统计特征（合并回长表）

全局汇总（跨所有赛季）：

- `partner_seasons` / `partner_contestants` / `partner_wins`
- `partner_avg_placement` / `partner_avg_last_week` / `partner_avg_season_score_pct`

无时间泄露版本（只用历史赛季）：

- `partner_seasons_prior` / `partner_contestants_prior` / `partner_wins_prior`
- `partner_avg_placement_prior` / `partner_avg_last_week_prior` / `partner_avg_season_score_pct_prior`

---

## 6. 表：dwts_season_summary.csv（选手-赛季汇总）

粒度：**一行 = 某选手的某个赛季**。

列说明：

- `celebrity_name`, `season`, `ballroom_partner`
- `celebrity_industry`, `celebrity_industry_clean`
- `celebrity_homecountry_clean`, `celebrity_homestate_abbr`, `is_foreign`
- `celebrity_age_during_season`
- `results`, `placement`
- `combine_method`：`percent` / `rank`
- `is_withdrawn`：是否退赛

表现汇总：

- `last_week_active`：最后一次出场周（整数）
- `season_mean_score_percentage`：全季周得分比例均值（数值）
- `season_judge_rank`：按 `season_mean_score_percentage` 的赛季内排名（1=最好）
- `score_rank_discrepancy`：评委排名 - 最终名次

---

## 7. 表：dwts_partner_summary.csv（舞伴全局汇总）

粒度：**一行 = 一个职业舞者（ballroom_partner）**。

列说明：

- `ballroom_partner`
- `partner_seasons`：带过的赛季数
- `partner_contestants`：合作过的明星数
- `partner_wins`：冠军次数
- `partner_avg_placement`：平均名次
- `partner_avg_last_week`：平均最后出场周
- `partner_avg_season_score_pct`：合作选手赛季平均得分比例的均值

---

## 8. 表：dwts_partner_summary_prior.csv（舞伴历史特征，无泄露）

粒度：**一行 = (ballroom_partner, season)**。

列说明：

- `ballroom_partner`, `season`
- `partner_seasons_prior`：该季之前带过的赛季数
- `partner_contestants_prior`：该季之前合作过的明星数
- `partner_wins_prior`：该季之前的冠军次数
- `partner_avg_placement_prior` / `partner_avg_last_week_prior` / `partner_avg_season_score_pct_prior`

---

## 9. 表：dwts_quality_report.csv（质量报告）

两列：

- `metric`：指标名（字符串）
- `value`：指标值（整数/字符串化对象）

常见 metric（可能随脚本迭代略有变化）：

- `rows_long` / `rows_present`
- `rows_all_zero_absent` / `rows_all_na_structural`
- `rows_with_any_out_of_range_judge`
- `judge_scores_above_10_bonus`：单评委分数 >10 的出现次数（用于描述奖励分/加分现象）
- `judge_scores_below_1_error`
- `zero_score_conflict_rows`
- `gap_week_rows`
- `missing_finale_scores_rows`
- `exit_week_mismatch_rows`
- `no_elimination_week_count`
- `rows_excluded_from_fan_vote_inference`
- `unique_seasons` / `unique_contestants` / `unique_partners`

---

## 10. 表：dwts_excluded_from_inference.csv（反推投票排除列表）

列说明：

- `celebrity_name`, `season`, `week`
- `results`, `result_type`
- `is_present`
- `weeks_since_exit`

用途：在做“粉丝投票反推”时，退赛或退赛后周次通常不满足模型假设，可直接过滤这些行。

---

## 11. 表：dwts_zero_score_conflicts.csv（0 分冲突明细）

结构与 `dwts_long_clean.csv` 相同（同样的列），只保留被标记为 `zero_score_conflict==True` 的行。

用途：人工复核数据异常（例如：results 显示仍在赛，但该周全 0 分）。

---

## 12. 常见问题（FAQ）

### Q1：为什么 base 环境跑不起来？

如果你看到类似：

> A module that was compiled using NumPy 1.x cannot be run in NumPy 2.x

说明 base 环境里 NumPy 与 pandas/pyarrow 等二进制扩展版本不兼容。最简单做法：用 `mcm_env` 跑。

### Q2：为什么有些赛季决赛周只有 2 人有分？

脚本用 `final_week_n_performers` 记录决赛周实际表演人数。有些赛季“第三名在决赛周之前确定”，因此第三名在决赛周可能全 0 分，这是正常结构，不应当作数据错误。

---

## 13. 复现建议（论文写作角度）

如果你在报告里需要描述“决赛周机制差异”，建议使用以下字段举证：

- `season_final_week`
- `final_week_n_performers`
- `expected_to_perform_in_finale`

它们能把“2/3/4/5 人决赛”这种结构差异显式化，便于你在模型中对决赛周做单独处理。

