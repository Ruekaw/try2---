# Q3 回归输出说明（outputs/q3_regression）

本说明基于当前版本代码：
- 主流程：[Q3_regression/q3_main.py](../../Q3_regression/q3_main.py)
- 特征工程与 K 选择：[Q3_regression/q3_features.py](../../Q3_regression/q3_features.py)
- 模型与汇总：[Q3_regression/q3_model.py](../../Q3_regression/q3_model.py)
- 数据加载与 NPZ 解析：[Q3_regression/q3_loader.py](../../Q3_regression/q3_loader.py)

> 说明：文件名中的 `k3` 表示本次运行选择的 `K=3`（只使用每个赛季前 K 周的数据）。若配置改为其他 K，会生成对应的 `*_k{K}.csv`。

运行开关（命令行）：
- 仅跑评委+粉丝点估计（跳过 NPZ 不确定性传播）：`python Q3_regression/q3_main.py --no-fan-samples`
- 仅跑评委（跳过粉丝点估计与传播）：`python Q3_regression/q3_main.py --no-fan-mean --no-fan-samples`

---

## 1. JSON 文件

### 1.1 k_selection.json
来源：`choose_k()` 的返回对象 `KSelectionReport` 直接 `json.dump(k_report.__dict__)`。

字段含义：
- `chosen_k`：最终采用的 K。
- `candidates`：候选 K 列表（来自 `Q3Config.k_candidates`）。
- `cover_rates`：字典，键为候选 K（字符串形式），值为覆盖率：
  - 覆盖率定义为：在所有赛季中，"该赛季前 K 周都存在有效比赛周" 的赛季占比。
- `survival_rates`：字典，键为候选 K，值为生存率均值：
  - 对每个赛季计算：`nk / n1`，其中
    - `n1`：赛季第 1 周（`week==1` 且 `is_competing_week==True`）的参赛人数
    - `nk`：赛季第 K 周（`week==K` 且 `is_competing_week==True`）的参赛人数
  - `survival_rates[k]` 为所有赛季上述比值的平均。

参见：[Q3_regression/q3_features.py](../../Q3_regression/q3_features.py#L17-L70)。

### 1.2 pro_effect_correlation_k3.json
来源：`pro_effect_correlation(pro_fan, pro_judge)`，其中 `pro_*` 来自随机效应汇总。

字段含义：
- `corr`：职业舞伴随机效应在粉丝模型和评委模型之间的 Pearson 相关系数。
  - 具体为：将 `fan_pro_effects_k3.csv` 与 `judge_pro_effects_k3.csv` 按 `ballroom_partner` 内连接，
    对 `mean_fan` 与 `mean_judge` 计算相关。
- `n_pairs`：用于计算相关的舞伴个数（两边都出现的舞伴数）。

参见：[Q3_regression/q3_model.py](../../Q3_regression/q3_model.py#L122-L152)。

---

## 2. 面板与特征 CSV

### 2.1 panel_k3.csv
来源（见 `main()`）：
1. 读取清洗后的 DWTS 长表 `outputs/dwts_long_clean.csv`，记为 `dwts`。
2. 读取 Q1 推断结果长表 `outputs/q1_mcmc/fan_vote_estimates_long.csv`，记为 `fan`。
3. 按键 `['season','week','celebrity_name']` 左连接合并。
4. 调用 `choose_k()` 选出 K，并筛选 `week <= K` 以及 `is_competing_week == True` 的行。
5. 调用 `add_core_features(df, eps)` 添加核心特征列：`industry, age, age_c, log_week, y_judge`。
6. 保存为 `panel_k{K}.csv`。

该表是一个“宽信息面板”，列很多，其中与 Q3 回归直接相关的核心列包括：

- `season`：赛季编号（整数）。
- `week`：周编号（整数）。
- `celebrity_name`：明星姓名（文本）。
- `ballroom_partner`：职业舞伴姓名（随机效应分组 1）。
- `celebrity_industry` / `celebrity_industry_clean`：原始/清洗后的行业标签。
- `industry`：建模用行业类别：
  - 若存在 `celebrity_industry_clean`，则 `industry = celebrity_industry_clean`；
  - 否则退回 `celebrity_industry`。
- `celebrity_age_during_season`：赛季期间年龄（原始），字符串/浮点形式。
- `age`：转为数值的年龄：`pd.to_numeric(celebrity_age_during_season, errors='coerce')`。
- `age_c`：中心化年龄：`age - age.mean()`（在当前 `panel_k{K}` 样本上的全局均值）。
- `log_week`：`np.log(week.astype(float))`。
- `week_score_share`：评委打分在本周内的份额（来自清洗表）。
- `y_judge`：评委侧响应变量，为 `week_score_share` 的“周内中心化对数”：
  - 先计算：`safe = log(week_score_share + eps)`；
  - 按 `(season,week)` 分组，对 `log(week_score_share + eps)` 取均值；
  - `y_judge = safe - group_mean`。
- `fan_vote_mean`：Q1 推断得到的粉丝票份额后验均值（来自 `fan_vote_estimates_long.csv`）。
- 其他 Q1 诊断列（若存在）：`fan_vote_std, fan_vote_ci_lower, fan_vote_ci_upper, snr, ci_width, ppc_consistency, hit_rate, elimination_count, mean_violation, acceptance_rate, converged` 等。

关于 `y_judge` 的公式，详见：[Q3_regression/q3_features.py](../../Q3_regression/q3_features.py#L72-L104)。

> 注：粉丝侧的 `y_fan` 在主流程中通常在内存里动态生成（`add_fan_centered_log`），并未写回 `panel_k3.csv`。

---

## 3. 固定效应汇总 CSV

### 3.1 judge_fixed_summary_k3.csv
### 3.2 fan_fixed_summary_k3.csv

来源：
- 对评委模型 / 粉丝模型的 `idata` 调用 `summarize_fixed_effects(idata)`，其内部为：
  - `names = fixed_effect_names(idata)` 过滤出固定效应变量；
  - `az.summary(idata, var_names=names, hdi_prob=hdi_prob)`；
  - `reset_index()` 并将索引列重命名为 `param`。

列含义（ArviZ 标准输出）：
- `param`：固定效应参数名，例如：
  - `Intercept`：整体截距；
  - `age_c`, `log_week`：对应协变量的回归系数；
  - `industry[XXX]`：行业类别的哑变量系数等（具体命名视 Bambi 编码而定）。
- `mean`：该参数后验均值。
- `sd`：后验标准差。
- `hdi_2.5%` / `hdi_97.5%`：后验 95% HDI 区间下界/上界。
- `mcse_mean` / `mcse_sd`：蒙特卡洛标准误（对 mean/sd 的不确定性评估）。
- `ess_bulk` / `ess_tail`：有效样本量（bulk / tail）。
- `r_hat`：Gelman-Rubin 收敛诊断（接近 1 为佳）。

参见：[Q3_regression/q3_model.py](../../Q3_regression/q3_model.py#L32-L59)。

---

## 4. 随机效应汇总 CSV

### 4.1 judge_pro_effects_k3.csv
### 4.2 fan_pro_effects_k3.csv

来源：
- 对评委 / 粉丝模型的 `idata` 调用：`summarize_random_effects(idata, 'ballroom_partner')`。
- 内部逻辑：
  - 在 `idata.posterior` 中查找包含 `ballroom_partner` 这一坐标的变量（即 `(1|ballroom_partner)` 的随机截距）；
  - 或在变量名里查找含 `ballroom_partner` 且含 `|` 的变量作为回退；
  - 对每个舞伴水平，计算：
    - `mean`：在所有链、抽样上的后验均值；
    - `hdi_lower` / `hdi_upper`：对 `(chain,draw)` 栈起来的样本，用分位数近似 95% 区间。

列含义：
- `ballroom_partner`：职业舞伴姓名。
- `mean`：该舞伴随机效应的后验均值（在 log-响应尺度上）。
- `hdi_lower`：该舞伴随机效应的 95% 区间下界。
- `hdi_upper`：该舞伴随机效应的 95% 区间上界。

参见：[Q3_regression/q3_model.py](../../Q3_regression/q3_model.py#L61-L120)。

### 4.3 judge_season_effects_k3.csv
### 4.4 fan_season_effects_k3.csv

来源：
- 与 4.1/4.2 同理，但调用：`summarize_random_effects(idata, 'season')`。
- 随机项对应公式中的 `(1|season)`。

列含义：
- `season`：赛季编号（与数据中的 `season` 一致）。
- `mean`：该赛季随机截距的后验均值。
- `hdi_lower` / `hdi_upper`：该赛季随机截距的 95% 区间下界/上界。

---

## 5. 粉丝-评委差异（固定效应）

### 5.1 delta_fixed_summary_k3.csv

来源：
- 先分别从粉丝/评委模型中提取固定效应名集合，取交集 `common`；
- 对于每个 `name in common`，构造：`delta = idata_fan.posterior[name] - idata_judge.posterior[name]`；
- 调用 `az.summary(delta, hdi_prob)` 汇总，并标记 `param=name`；
- 对所有参数的结果按行拼接。

列含义（与 3.1/3.2 相同）：
- `param`：固定效应参数名。
- `mean`：粉丝侧系数减去评委侧系数的后验均值（$\beta_{fan} - \beta_{judge}$）。
- `sd`、`hdi_2.5%`、`hdi_97.5%`、`mcse_*`、`ess_*`、`r_hat`：同上，只是针对差值分布。

参见：[Q3_regression/q3_model.py](../../Q3_regression/q3_model.py#L122-L152)。

---

## 5b. 共同样本（Common-sample）对齐版输出（推荐用于“差异性比较”主结论）

背景：粉丝点估计模型会先根据 `fan_vote_mean` 构造 `y_fan`，再 `dropna(subset=['y_fan'])`，因此粉丝模型天然只使用“`y_fan` 可用”的行；而评委模型默认可以使用更多行。若直接用两边各自样本得到的后验做差（`delta_fixed_summary_k{K}.csv`），差值可能混入“样本不同”带来的偏差。

因此主流程会在粉丝点估计开启时，额外在同一批行上重跑一次评委模型，并输出一套 `*_common_k{K}` 文件。

### 5b.1 judge_fixed_summary_common_k3.csv
来源：对齐到粉丝点估计有效样本（`y_fan` 可用行）后，重新拟合得到的评委模型固定效应汇总。

### 5b.2 judge_pro_effects_common_k3.csv / judge_season_effects_common_k3.csv
来源：同上，对齐样本后的评委模型随机效应汇总。

### 5b.3 delta_fixed_summary_common_k3.csv
来源：用粉丝点估计模型的 `idata_fan` 与对齐样本后的评委模型 `idata_judge_common` 做差（f\beta_{fan} - \beta_{judge,common}$）。

### 5b.4 pro_effect_correlation_common_k3.json
来源：将 `fan_pro_effects_k3.csv` 与 `judge_pro_effects_common_k3.csv` 按 `ballroom_partner` 内连接后计算 Pearson 相关。

---

## 6. 粉丝样本集敏感性分析

### 6.1 fan_sample_fixed_quantiles_k3.csv

来源（main 中 `use_fan_samples` 分支）：
1. 通过 `build_npz_index()` 读取 Q1 导出的 `season_*_samples.npz`，建立 `(season,week) -> NPZWeekSamples` 索引。
2. `build_fan_sample_sets(df, npz_index, n_sets, seed)` 为每组 `fan_vote_sample` 构造与面板对齐的一列：
   - 对每个 `(season,week)` 随机抽取一条样本（一个样本向量对应当周所有选手）；
   - 将该向量映射/对齐到当前 `df` 的行顺序上，填充为该行的粉丝份额；
   - 重复 `n_sets` 次，形成多个 sample set。
3. 对于第 `i` 个 sample set：
   - 构造 `df_s`，令 `df_s['fan_vote_sample'] = s.values`；
   - 通过 `add_fan_centered_log(df_s, 'fan_vote_sample', eps)` 得到 `y_fan`；
   - 用同一公式 `y_fan ~ age_c + log_week + industry + (1|ballroom_partner) + (1|season)` 重新拟合粉丝模型；
   - 提取该次拟合的固定效应后验均值，记为一个 `Dict[param -> mean]`。
4. 收集所有 sample set 的固定效应均值，记为列表 `fan_means`；
5. 调用 `_quantile_table(fan_means)`：
   - 先构造二维数组 `arr`，行为不同 sample set，列为参数；
   - 对每列计算分位数和大于 0 的比例。

列含义：
- `param`：固定效应参数名。
- `q2.5` / `q50` / `q97.5`：在“多次拟合得到的后验均值”上的 2.5%、50%、97.5 分位数。
  - 注意：这是 **跨样本集的分位数**，不是单次 MCMC 后验的 HDI。
- `p_gt_0`：在所有 sample set 的均值中，大于 0 的比例（近似反映“在不同粉丝样本集下，该效应为正的频率”）。

### 6.2 fan_sample_delta_quantiles_k3.csv

来源：
- 在每个 sample set 上，先得到粉丝模型固定效应后验均值 `fan_mean`；
- 再与评委模型固定效应均值 `judge_means` 做差：`delta_mean[param] = fan_mean[param] - judge_means.get(param, 0)`；
- 将所有 `delta_mean` 字典组成列表，输入 `_quantile_table()`。

列含义同 6.1，只是值对应的是“粉丝-评委 差值”的多次拟合分布。

---

如果你后续改了 K 值、采样设置或新增了输出文件，可以在这个文档基础上增补；若你希望额外输出一个精简的“建模输入面板”（类似 `season, week, celebrity_name, ballroom_partner, industry, age_c, log_week, y_judge, y_fan`），也可以在主脚本中加一行导出，我可以帮你一起改。