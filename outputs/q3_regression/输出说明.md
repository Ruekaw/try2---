# Q3 回归输出说明（outputs/q3_regression）

本文档根据代码生成逻辑（见 [Q3_regression/q3_main.py](../../Q3_regression/q3_main.py)、[Q3_regression/q3_features.py](../../Q3_regression/q3_features.py)、[Q3_regression/q3_model.py](../../Q3_regression/q3_model.py)、[Q3_regression/q3_loader.py](../../Q3_regression/q3_loader.py)）整理。

> 说明：文件名中的 `k3` / `K3` 表示本次运行选择的 `K=3`（只使用每个赛季前 K 周的数据）。如果你改了 K，会生成对应的 `*_k{K}.csv`。

## 1. 两个 JSON

### 1.1 k_selection.json
来源：`choose_k()` 结果直接 `json.dump(k_report.__dict__)`。

字段含义：
- `chosen_k`：最终采用的 K。
- `candidates`：候选 K 列表（来自配置 `k_candidates`）。
- `cover_rates`：覆盖率，定义为“赛季中至少有 K 个有效比赛周”的赛季占比。
- `survival_rates`：生存率均值，定义为对每个赛季计算 `nk/n1` 后再取平均：
  - `n1`：该赛季第 1 周（week==1 且 `is_competing_week==True`）的有效参赛人数
  - `nk`：该赛季第 K 周（week==K 且 `is_competing_week==True`）的有效参赛人数

对应代码：见 [Q3_regression/q3_features.py](../../Q3_regression/q3_features.py#L1)。

### 1.2 pro_effect_correlation_k3.json
来源：`pro_effect_correlation(pro_fan, pro_judge)`。

字段含义：
- `corr`：职业舞伴（`ballroom_partner`）随机效应均值在“粉丝模型 vs 评委模型”之间的皮尔逊相关系数。
- `n_pairs`：参与计算相关系数的舞伴数量（fan/judge 两边都能对齐上的舞伴数）。

备注：如果 `judge_pro_effects_k3.csv` 或 `fan_pro_effects_k3.csv` 为空，`n_pairs` 会是 0，此时 `corr` 会是 NaN。

## 2. 面板与特征 CSV

### 2.1 panel_k3.csv
来源：
1) 读取 `outputs/dwts_long_clean.csv`（清洗后的 DWTS 长表）
2) 读取 `outputs/q1_mcmc/fan_vote_estimates_long.csv`（Q1 推断输出长表）
3) 以 `season, week, celebrity_name` 左连接合并
4) 只保留 `week <= K` 且 `is_competing_week == True` 的行
5) 新增核心特征列（见下方）

表结构说明：这是一个“**原始清洗长表 + Q1 粉丝推断列 + Q3 新增特征列**”的综合面板，因此列很多。

推荐重点关注（与 Q3 建模直接相关）列：
- `season`：赛季编号
- `week`：周编号
- `celebrity_name`：明星姓名（个体）
- `ballroom_partner`：职业舞伴（随机效应分组 1）
- `industry`：行业分类（由 `celebrity_industry_clean` 优先，否则回退 `celebrity_industry`）
- `age`：`celebrity_age_during_season` 转数值后的年龄
- `age_c`：中心化年龄，`age - mean(age)`（全样本均值）
- `log_week`：`log(week)`
- `y_judge`：评委得分份额的“组内中心化对数”，详见下面公式
- `fan_vote_mean`：Q1 推断得到的粉丝份额后验均值（来自 `fan_vote_estimates_long.csv`）
- `y_fan`：本文件里不一定有（Q3 运行时在内存里临时生成），若你另存了 frame 点估计表则见 2.2

此外，和 Q1 推断质量相关的列（来自 `fan_vote_estimates_long.csv`，用于诊断/筛选）常见包括：
- `fan_vote_std` / `fan_vote_ci_lower` / `fan_vote_ci_upper`
- `snr`、`ci_width`、`ppc_consistency`、`hit_rate`、`mean_violation`、`acceptance_rate`、`converged`

#### y_judge / y_fan 的定义（核心）
对于任意 share 列（例如 `week_score_share` 或 `fan_vote_mean`），Q3 使用：

- 先做安全对数：$\log(share + \varepsilon)$
- 再对每个 `(season, week)` 分组做中心化：

$$
 y = \log(share + \varepsilon) - \text{mean}_{(season,week)}\big[\log(share + \varepsilon)\big]
$$

对应代码：见 [Q3_regression/q3_features.py](../../Q3_regression/q3_features.py#L41-L86)。

### 2.2 q3_frame_point_K3.csv
这个文件不是当前版本 [Q3_regression/q3_main.py](../../Q3_regression/q3_main.py) 直接写出的（可能是你之前版本/额外脚本导出的“建模点估计面板”）。

从表头看，它是为建模准备的精简面板（点估计）：
- `season, week, celebrity_name, ballroom_partner`：主键与分组
- `industry`：行业分类
- `age_centered`：中心化年龄（等价于 `age_c`）
- `log_week`：对数周数
- `y_judge`：评委侧响应
- `y_fan`：粉丝侧响应（通常来自 `fan_vote_mean` 的 centered-log）

如果你希望这个文件稳定由主脚本产出，我也可以把它集成回 [Q3_regression/q3_main.py](../../Q3_regression/q3_main.py)。

## 3. 模型汇总 CSV（Bambi/PyMC/ArviZ）

Q3 拟合的公式为（见 [Q3_regression/q3_model.py](../../Q3_regression/q3_model.py#L1)）：

- `y ~ age_c + log_week + industry + (1|ballroom_partner) + (1|season)`

其中：
- `age_c, log_week, industry`：固定效应
- `(1|ballroom_partner)`：舞伴随机截距
- `(1|season)`：赛季随机截距

### 3.1 judge_fixed_summary_k3.csv / fan_fixed_summary_k3.csv
来源：`arviz.summary(idata, var_names=[...])` 后 `reset_index()`。

列含义（ArviZ 常规输出）：
- `param`：参数名（例如 `Intercept`、`age_c`、`log_week`、以及 `industry[...]` 的各水平哑变量等；具体命名由 Bambi 的编码方式决定）
- `mean`：后验均值
- `sd`：后验标准差
- `hdi_2.5%` / `hdi_97.5%`：95% HDI 区间
- `mcse_mean` / `mcse_sd`：蒙特卡洛标准误
- `ess_bulk` / `ess_tail`：有效样本量（bulk / tail）
- `r_hat`：Gelman-Rubin 收敛诊断（接近 1 更好）

### 3.2 judge_pro_effects_k3.csv / fan_pro_effects_k3.csv
预期来源：从 `idata.posterior` 中寻找包含 `ballroom_partner` 且带 `|` 的随机效应变量，并导出每个舞伴水平的：
- `ballroom_partner`：舞伴名称
- `mean`：该舞伴随机效应均值
- `hdi_lower` / `hdi_upper`：HDI 区间

备注（重要）：
- 你当前这两个文件是空白，表示在 `idata.posterior` 里没有匹配到预期命名的随机效应变量（可能是 Bambi 版本的命名规则不同导致）。
- 这不影响固定效应汇总，但会导致 `pro_effect_correlation_k3.json` 的 `n_pairs=0`。

### 3.3 judge_season_effects_k3.csv / fan_season_effects_k3.csv
与 3.2 类似，但分组是 `season`：
- `season`：赛季水平
- `mean`：赛季随机效应均值
- `hdi_lower` / `hdi_upper`：HDI 区间

备注：同样可能因命名规则匹配不到而生成空文件。

### 3.4 delta_fixed_summary_k3.csv
来源：对每个共同固定效应参数，计算 `delta = fan_posterior - judge_posterior`，然后用 `arviz.summary(delta)` 汇总。

列含义同 3.1（`mean/sd/hdi/ess/r_hat` 等），但解释为：
- `mean`：粉丝侧效应均值减去评委侧效应均值（$\beta_{fan}-\beta_{judge}$）
- HDI：该差值的不确定区间

## 4. “样本集敏感性”汇总 CSV（fan_sample_*）

这两张表不是对单次后验的总结，而是对“重复拟合多次（默认 50 次）”得到的**点估计集合**做分位数汇总：

### 4.1 fan_sample_fixed_quantiles_k3.csv
来源：每次从 NPZ 中为每个 `(season, week)` 抽取一组粉丝份额样本（对齐到面板行），重新拟合粉丝模型，取固定效应后验均值；重复 `fan_sample_sets` 次。

列含义：
- `param`：固定效应参数名
- `q2.5` / `q50` / `q97.5`：跨“多次拟合的后验均值”的分位数
- `p_gt_0`：跨“多次拟合的后验均值”中大于 0 的比例（不是后验概率，而是多次拟合的频率）

### 4.2 fan_sample_delta_quantiles_k3.csv
同 4.1，但对每次拟合的 `fan_mean - judge_mean` 做分位数汇总。

## 5. 想进一步完善（可选）
- 如果你希望 `judge_pro_effects_k3.csv` / `fan_pro_effects_k3.csv` 不再为空，我可以按你当前 Bambi 版本的 `idata.posterior` 实际变量名，改写 [Q3_regression/q3_model.py](../../Q3_regression/q3_model.py) 的随机效应提取逻辑。
- 如果你希望稳定输出 `q3_frame_point_K{K}.csv`，也可以把它集成进主脚本，确保每次都生成。
