第三问（Q3）建模主线（简单版）：前 K 周切片 + 分层回归 + 评委/粉丝对比

> 目标：用“前 K 周更接近全体参赛者、存活选择偏差更弱”的样本，量化 Pro 与明星特征对表现的影响，并比较评委 vs 粉丝是否“同方式”影响。

## 0. 要回答的问题

- 量化影响：职业舞者（Pro）与明星特征（年龄、行业等）对表现的影响有多大？
- 差异性比较：这些因素对评委打分与粉丝投票是否同方向/同强度？

## 1. 数据与连接（输入/输出口径）

### 1.1 输入数据

- 清洗后的周面板：`dwts_long_clean.csv`
- Q1 反推粉丝份额：
  - 点估计（快速版）：`fan_vote_estimates_long.csv`
  - 传播不确定性（推荐版）：`Q1_data_expo/*.npz`
    - 做法：从 `.npz` 中随机抽取 S 组「完整的粉丝投票历史样本」（覆盖多赛季/多周/所有选手的 fan share），对每一组样本分别完成一次 Q3 回归；最后汇总系数分布（相当于把 Q1 的后验不确定性向 Q3 传递）。

### 1.2 最小连接键

- `season`, `week`, `celebrity_name`

## 2. 样本构造：前 K 周切片法（核心）

### 2.1 基本切片规则

- 只保留 `is_competing_week == True` 的记录（确保当周确实参赛/表演）
- 只保留 `week <= K`

推荐先从 K=3 或 K=4 起步（通常越早偏差越小，但信息越少）。

### 2.2 为什么前 K 周能缓解生存偏差

- 生存偏差主要出现在后期：后期只剩强者，样本不再代表全体参赛者。
- 早期周次更接近“全员参与”的横截面，选择机制尚未强烈筛掉弱者。

### 2.3 稳健性（必须做）

- 对 K 做敏感性：K ∈ {3,4,5}（或按数据可用性扩展）
- 若关键结论（系数方向/量级）随 K 稳定，则对写作更有说服力。

### 2.4 K 的选择规则（落地口径）

为避免“样本量骤降”或“只剩强者导致偏差加重”，选择 K 时遵循两条原则：

1) K 不能超过大多数赛季的早期无缺失周。
  - 操作化：对每个 season 计算“从 Week 1 起连续无缺失且 `is_competing_week==True` 的最长前缀周数”，记为 `K_complete(season)`；选择候选 K 满足 `P(K <= K_complete(season))` 足够高（例如 ≥80%）。

2) K 选在“多数赛季仍接近全员参赛”的区间。
  - 操作化：对每个 season 定义存活比例 `survival_ratio(K) = n_active_weekK / n_active_week1`；选择候选 K 使得 `mean_s(survival_ratio_s(K))` 不低于阈值（例如 ≥0.75）。

实际执行：先固定候选集 K ∈ {3,4,5}，再用以上两条规则过滤；若多个 K 同时满足，则优先选更小的 K，并用其余 K 做敏感性对照。

## 3. 统一因变量：同周份额 → Centered log

核心思想：评委侧与粉丝侧都先构造同一 (season, week) 内的份额（sum-to-1），再做 centered log 变换，得到可比的连续响应。

### 3.1 份额定义

- 评委份额：s^judge_it = week_score_share（清洗表已给）
- 粉丝份额：s^fan_it = fan_vote_mean（Q1 输出）

### 3.2 Centered log 变换

取平滑常数 ε（如 1e-6），在同一 (season, week) 的参赛选手集合上中心化：

y^judge_it = ln(s^judge_it + ε) - mean_{同周} ln(s^judge + ε)

y^fan_it   = ln(s^fan_it   + ε) - mean_{同周} ln(s^fan   + ε)

解释：y 表示“相对份额的对数优势”。这种口径能消除不同赛季打分尺度、不同周参赛人数变化带来的不可比。

> 备注（取舍说明）：本次实现不展开 ε 的敏感性分析（时间约束）。统一固定 ε，并在报告中说明这一建模选择。

## 4. 自变量与分层结构（主模型）

### 4.1 固定效应（想回答的因素）

- Age：celebrity_age_during_season（建议中心化）
- Industry：celebrity_industry_clean（分类变量）
- log_week：log(week)（控制赛程趋势/学习曲线）

可选（若你们想更“比赛过程”一些）：加入 week 的二次项或样条，但简单版不强求。

### 4.2 随机效应（分层结构）

- Pro：ballroom_partner（职业舞者 ID）
- Season：season

### 4.3 识别性约束：不使用 (1|celebrity_name)

若要解读年龄/行业等“明星静态特征”的系数，模型不加入 (1|celebrity_name)。原因：年龄/行业对同一明星不随周变化，会被明星随机截距吸收，导致这些固定效应难以识别。

## 5. 两套分层回归：评委 vs 粉丝

两套模型结构尽量一致，便于对比。

### 5.1 评委侧模型

y^judge_it ~ Normal(mu^judge_it, sigma_judge)

mu^judge_it = α_judge + β_judge^T X_it + a^judge_pro[Pro_it] + a^judge_season[season]

### 5.2 粉丝侧模型

y^fan_it ~ Normal(mu^fan_it, sigma_fan)

mu^fan_it = α_fan + β_fan^T X_it + a^fan_pro[Pro_it] + a^fan_season[season]

其中 X_it 至少包含：Age、Industry、log_week。

## 6. 输出如何回答题目

### 6.1 量化影响（How much impact?）

- 年龄：报告 β_age 的后验均值/95% HDI（或置信区间），以及方向（正/负）
- 行业：报告各行业相对基准类的系数分布（森林图）
- Pro：
  - 方差分量：σ_pro 的大小（可与残差方差对比，给“职业舞者差异有多大”的量级解释）
  - 个体效应：输出每个 Pro 的随机截距 a_pro 的后验均值/区间，做排名或分位数（Top/Bottom）

### 6.2 差异性比较（Same way?）

对同名系数做差值后验：

Δβ = β^fan - β^judge

报告：Δβ 的 95% HDI 与 P(Δβ > 0)（或 <0）。

此外可对比 Pro 随机效应：散点图 a_pro^judge vs a_pro^fan（相关系数/回归斜率），回答“同一个 Pro 是否评委强也粉丝强”。

### 6.3 将 Q1 不确定性传播到 Q3（必须做）

设从 `.npz` 抽到的完整粉丝份额样本为 `s_fan^{(1)}, ..., s_fan^{(S)}`：

- 对每个 s=1..S：
  1) 用 `s_fan^{(s)}` 替换 `fan_vote_mean`，重新构造 `y_fan^{(s)}`
  2) 用相同的自变量/分层结构拟合同一套粉丝侧模型，得到 `β_fan^{(s)}`、`a_pro_fan^{(s)}` 等
- 汇总：
  - 系数分布：对每个系数取分位数区间（例如 2.5%/50%/97.5%），并报告符号概率（例如 `P(β>0)`）
  - 差值分布：`Δβ^{(s)} = β_fan^{(s)} - β_judge`（评委侧可视作确定或单次拟合）

解释口径：这一步把“反推粉丝份额的不确定性”显式传递到 Q3 的结论不确定性上，避免只用均值导致过度自信。

## 7. 与规则相关的说明（简单版写作口径）

- 评委救人（S28+）会改变淘汰机制，但简单版不显式建模淘汰过程。
- 通过只看前 K 周，我们尽量在“救人机制影响尚未强烈改变样本构成”的早期区间做对比；并通过 K 敏感性检验保证结论稳健。

## 8. 落地步骤（工程化清单）

1) 读入 dwts_long_clean 与 fan_vote_estimates_long，按 (season, week, celebrity_name) 合并
2) 选择 K：在候选集 K ∈ {3,4,5} 上，先用“早期无缺失”+“存活比例阈值”规则筛选，再确定主 K，并保留其余 K 做敏感性
3) 过滤：is_competing_week==True 且 week<=K
4) 构造 y_judge / y_fan（centered log）
5) 把 industry / season / ballroom_partner 转成分类变量
6) 拟合评委侧分层模型（单次）
7) 粉丝侧：从 `.npz` 随机抽取 S 组完整 fan share 样本；对每一组重复 3-6（或在固定样本集上只替换 fan 并拟合粉丝侧）
8) 汇总输出：
  - β_judge、β_fan 的分布（由 S 组 fan 回归汇总）
  - Δβ 的分布与符号概率
  - Pro 随机效应：两侧相关性/Top-Bottom 稳健性
9) 对 K ∈ {3,4,5} 重复 2-8，汇总“随 K 是否稳定”

> 备注（取舍说明）：本次实现不单独解决 Pro 效应的严格因果识别问题；报告中将其表述为“Pro-配对的综合关联效应”，并避免因果措辞。

## 9. 伪代码（Bambi/PyMC 风格）

```python
# df = merge(dwts_long_clean, fan_vote_estimates_long)
# df = df[(df.is_competing_week) & (df.week <= K)]
# df['y_judge'] = centered_log_share(df['week_score_share'], by=['season','week'])
# df['y_fan']   = centered_log_share(df['fan_vote_mean'],   by=['season','week'])
# df['log_week'] = np.log(df['week'])
# 
# model_j = bmb.Model('y_judge ~ age + industry + log_week + (1|ballroom_partner) + (1|season)', df)
# fit_j = model_j.fit(...)
# model_f = bmb.Model('y_fan   ~ age + industry + log_week + (1|ballroom_partner) + (1|season)', df)
# fit_f = model_f.fit(...)
# 
# compare: Delta_beta = beta_f - beta_j
# compare: a_pro_fan vs a_pro_judge
```
