本文件给出 Q2 的**逐周反事实推演**完整建模思路：将 Q1 产出的“每周粉丝投票份额后验样本”（10,000 次/周）作为输入，在一个受控沙盒中复刻“该周赛制如何决定淘汰/排名”，并对 34 个赛季做宏观统计与个案追踪。

> 关键立场：**不做整季动态反事实**（不在反事实淘汰后重算后续周粉丝票迁移），只做“固定当周参赛集合”的逐周机制比较。这一选择更稳定、假设更少、结论更可复现。

---

## 1. 数据与口径（Q1 输出 → Q2 输入）

### 1.1 输入文件
- Q1 后验样本：`Q1_data_expo/season_XX_samples.npz`
	- 结构约定：每个赛季包含若干周的 `week_Y_samples`（形状 `10000 x N`）与 `week_Y_names`（长度 `N` 的选手名顺序）。
	- `week_Y_samples[s, i]` 表示第 `s` 次后验抽样下，第 `i` 个选手的粉丝投票**份额**（各选手份额和为 1）。
- 清洗后的评委数据：`outputs/dwts_long_clean.csv`
	- 用于抽取当周参赛者名单、评委分口径、周类型标记（无淘汰/双淘汰/决赛等）、以及“可推断行”过滤。

### 1.2 评委分与赛制字段口径（重要）
为了避免概念混淆，Percent 制（S3–S27）里使用 **当周评委份额**而非“相对满分比例”。

- Judge 总分（用于“更低评委分者淘汰”的比较）：
	- 使用 `week_total_score`（或等价的当周评委合计分数）。
- Percent 制的 `%Judge`：
	- 使用 `week_score_share`（当周评委分在参赛者之间的份额），而不是 `week_score_percentage`（相对满分的比例）。

---

## 2. 推演范围：哪些周纳入核心统计？

为保证指标与“单淘汰机制”一致，核心统计只覆盖：

### 2.1 核心统计周（用于翻转率/冤死率/人气主导率）
对每个赛季的每一周，满足以下条件才纳入核心统计：
- 单淘汰周：`is_double_elimination == False`
- 非无淘汰周：`is_no_elimination == False`
- 非决赛周：`is_final_week == False`
- 当周参赛有效：选手行满足 `is_present == True` 且 `exclude_from_fan_vote_inference == False`

> 注：退赛/缺失评分等异常情况，统一通过 `exclude_from_fan_vote_inference` 与清洗标记过滤，避免人为主观分支。

### 2.2 决赛周专题（单独分析）
决赛周不是“淘汰”而是“排序/冠军判定”，单独做专题输出：
- 在每个后验样本下计算“该赛制下的冠军/名次分布”。
- 仍然遵循“逐周反事实”原则：只在历史决赛当周参赛集合上做反事实排名，不做整季参赛集合变化。

---

## 3. 四个平行宇宙（Scenarios）规则定义

我们构建一个 SimulationEngine：对每个“有效周”，在同一周的 10,000 个粉丝样本下，分别按 4 套规则计算淘汰者（或决赛周冠军）。

设当周参赛人数为 $N$，粉丝份额样本矩阵为 $F \in \mathbb{R}^{S\times N}$（$S=10000$），评委总分向量为 $J \in \mathbb{R}^{N}$，评委份额向量为 $J^{share} \in \mathbb{R}^N$（来自 `week_score_share`）。

### 宇宙 A：Rank - Direct（S1–S2）
- JudgeRank：对 $J$ 做从高到低排名（高分=好名次=1）。
- FanRank：对每个样本 $F_s$ 做从高到低排名。
- 综合名次：$SumRank = Rank(J) + Rank(F_s)$。
- 淘汰：$\arg\max_i SumRank_i$（名次和最大=最差）。

### 宇宙 B：Rank - Save（S28+）
- 先计算 $SumRank$。
- 取 $SumRank$ 最差的 2 人作为 Bottom-2。
- 淘汰规则：淘汰 Bottom-2 中 **评委总分 $J$ 更低**者。
- 平局裁决（你已定死）：
	1) 若 Bottom-2 评委总分相同，则回溯该样本的粉丝票：淘汰 **粉丝份额 $F_s$ 更低**者（回归大众意愿）。
	2) 若仍相同（极少），用选手名的字典序作为最终 tie-break，保证可复现。

### 宇宙 C：Percent - Direct（S3–S27）
- 综合百分比：$Total = J^{share} + F_s$。
- 淘汰：$\arg\min_i Total_i$（总份额最小=最差）。

### 宇宙 D：Percent - Save（Hypothetical/推荐）
- 先计算 $Total = J^{share} + F_s$。
- 取 $Total$ 最差的 2 人作为 Bottom-2。
- 淘汰规则：淘汰 Bottom-2 中 **评委总分 $J$ 更低**者。
- 平局裁决同宇宙 B：若评委分相同，则淘汰该样本下粉丝份额更低者；再不行用名字字典序。

---

## 4. 关键工程点：对齐与过滤（决定能不能跑通）

### 4.1 选手顺序严格对齐
对每个赛季每一周：
1) 从 `dwts_long_clean.csv` 抽取该周“有效参赛者集合”（`is_present==True` 且未排除）。
2) 读取 `week_Y_names`，用选手名对齐到清洗表的行，得到 $J, J^{share}$ 的顺序与 $F$ 完全一致。
3) 若出现名字无法匹配（同名/别名/空格差异），应在 Loader 层做标准化（strip、大小写、特殊字符），并将无法对齐的周直接记录为“跳过原因”，避免默默错位。

### 4.2 周类型过滤一处统一实现
在 Loader 阶段就生成三类周清单：
- core_weeks：用于核心统计
- finale_weeks：用于决赛专题
- skipped_weeks：记录跳过原因（无淘汰/双淘汰/数据缺失/无法对齐）

---

## 5. 输出与指标（收敛到最关键的 3 个）

对每个核心统计周、每个宇宙方法，基于 10,000 次模拟淘汰结果，统计一组“可解释、能直接回答题目第二小问”的主指标；其余指标作为自检/附录。

> 论文写作建议：正文优先展示“Rank vs Percent 的差异程度 + 差异方向”、“加入评委救人后的制度影响”、“决赛最终结果改变多少”；
> 与历史真实淘汰的一致性（reversal）可作为稳健性补充。

### 5.1 Rank vs Percent：同周差异有多大、差在哪边（主指标）

我们在**同一周、同一批后验样本**下，对比 Rank-direct 与 Percent-direct：

- 淘汰分歧率（差多大）：
$$D_{elim}=P(E_{rank}\neq E_{percent})$$

- 差异方向（偏粉丝/偏评委）：
	- 定义被淘汰者在当周的“排序分位 badness quantile”（0=当周最好，1=当周最差），分别对粉丝端与评委端计算。
	- 在发生分歧的样本中，统计 Rank 是否更“保护粉丝”与更“保护评委”的比例：
		- `rank_more_fan_friendly_rate_if_disagree`
		- `rank_more_judge_friendly_rate_if_disagree`

对应输出：
- 周级：`outputs/q2_counterfactual/rank_vs_percent_by_week.csv`
- 赛季汇总：`outputs/q2_counterfactual/rank_vs_percent_by_season.csv`
- 总体汇总：`outputs/q2_counterfactual/rank_vs_percent_overall.csv`
- 关键赛季可视化（示例 S27）：`outputs/q2_counterfactual/rank_vs_percent_S27_heatmap.png`

### 5.2 Reversal Rate（翻转率，自检/稳健性）
与历史真实淘汰者不一致的概率：
$$P(\text{SimElim} \neq \text{ActualElim})$$

### 5.3 Tech/Popularity 指标（附录/机制解释）

这两项在多数周天然接近 0（因为“第一名被淘汰”本就罕见），更适合作为机制解释或附录自检，而非正文主指标。

#### Tech-Vulnerability（技术冤死率）
当周评委总分最高者被淘汰的概率：
$$P(\text{SimElim} = \arg\max(J))$$
该值越小，说明规则越“尊重技术”。

#### Popularity Dominance（人气被冤死率/人气保护性）
当周粉丝份额第一名被淘汰的概率：
$$P(\text{SimElim} = \arg\max(F_s))$$
该值越小，说明规则越“照顾流量/大众意愿”。

> 说明：Alignment Score 可视为 $1-\text{ReversalRate}$。

### 5.4 “最终结果改变多少”：决赛冠军/名次变化（主指标）

决赛周不是“淘汰”，而是“名次/冠军”。我们在历史决赛当周参赛集合固定的条件下，对比 Rank 与 Percent 的最终结果差异：

- 决赛冠军改变概率：
$$D_{winner}=P(\text{winner}_{rank}\neq \text{winner}_{percent})$$

- 对题目点名争议选手的结论（决赛当周参赛集合固定）：
	- `win_prob_rank / win_prob_percent`：夺冠概率
	- `delta_win_prob(rank_minus_percent)`：夺冠概率差
	- `exp_place_rank / exp_place_percent` 与 `delta_exp_place(rank_minus_percent)`：期望名次差

对应输出：
- 决赛周级：`outputs/q2_counterfactual/finale_winner_change_by_week.csv`
- 决赛赛季汇总：`outputs/q2_counterfactual/finale_winner_change_by_season.csv`
- 决赛总体汇总：`outputs/q2_counterfactual/finale_winner_change_overall.csv`
- 争议选手差异：`outputs/q2_counterfactual/finale_celebrity_outcome_deltas.csv`

### 5.5 非决赛周：赛季“走多远”的代理量化（主指标补全）

在不做整季动态反事实（不模拟票迁移/参赛集合反馈）的前提下，我们将“逐周被淘汰概率”视作 hazard 近似，得到：

- `survive_prob_through_modeled_weeks`：在被建模的这些周中都不淘汰的概率（“走到最后一周”的代理）
- `expected_exit_week_index / expected_exit_week_label`：期望出局周（将幸存者视为出局周 = n+1 的约定）

对应输出：`outputs/q2_counterfactual/tracker_survival_summary.csv`

---

## 6. 个案追踪（题目点名的 4 位争议选手）

建立 tracker，输出“逐周被淘汰概率时间线”（在有效周中）：
- 对指定选手 $c$，每周计算 $P(\text{SimElim}=c)$，分别对应宇宙 A/B/C/D。
- 图表建议：
	- X 轴：周次
	- Y 轴：淘汰概率
	- 4 条线：A/B/C/D

对应输出：
- 数据：`outputs/q2_counterfactual/tracker_elimination_probabilities.csv`
- 图：`outputs/q2_counterfactual/trackers/`

该部分的论文表达重点：
- 解释“他在某些周处于 Bottom 区域”的原因（评委弱/粉丝弱/规则偏好）。
- 比较 Rank vs Percent 以及 Save 机制是否显著降低“冤死风险”。

> 注：题目点名 4 人分别是 Jerry Rice（S2）、Billy Ray Cyrus（S4）、Bristol Palin（S11）、Bobby Bones（S27）。

---

## 7. 工程实施 Roadmap（最小可跑通版本）

### 7.1 Loader
- 遍历赛季文件 `Q1_data_expo/season_XX_samples.npz`
- 对每周：读取 `week_Y_names`、`week_Y_samples`
- 从 `outputs/dwts_long_clean.csv` 抽取同赛季同周数据，按名字对齐得到：
	- $J$：`week_total_score`
	- $J^{share}$：`week_score_share`
	- ActualElim：从清洗字段推导当周真实淘汰者（以“当周离开且非决赛”为准）
	- 周类型标记与过滤标记

### 7.2 Kernel（严格向量化）
- 输入：$J, J^{share}, F$
- 输出：每个方法在 10,000 个样本下的淘汰者索引（`int32` 即可）
- 注意：Rank 制下 FanRank/Bottom-2 需要在样本维度上批量 rank；Percent 制直接比较矩阵即可。

### 7.3 Analyzer
- 汇总 34 赛季核心统计周的三大指标，输出：
	- 按方法聚合的总体指标
	- 按赛季分组的指标（展示机制随时代变化的稳健性）
- Rank vs Percent 对比：输出周级分歧率与方向性指标，并给出关键赛季（如 S27）的周级热力图。
- 决赛专题：输出冠军改变概率与争议选手（若在决赛中）的夺冠/名次差。
- 跑 tracker：对题目点名 4 人输出逐周淘汰概率曲线，并汇总生存/期望淘汰周指标。

---

## 8. 局限性声明（论文必须写清楚的“防喷点”）

本 Q2 采用逐周反事实（固定参赛集合）假设：
- 一旦反事实淘汰者与真实历史不同，后续周的参赛集合在现实中会改变；本模型不模拟这种跨周反馈。
- 因此本模型主要回答：**在“同一周、同一组选手”条件下，不同赛制对淘汰/排名决策的影响**；而非严格预测“整季冠军会如何变化”。
