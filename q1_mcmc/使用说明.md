# MCM 2026 Problem C - Q1: MCMC粉丝投票反推模型

## 📋 项目概述

本模块实现基于 **Metropolis-Hastings 算法** 的贝叶斯推断，用于反推 DWTS（与星共舞）节目中未公开的粉丝投票分布。

### 核心思想

- **状态空间**：单纯形 $\Delta^{n-1} = \{v \in \mathbb{R}^n : \sum v_i = 1, v_i \geq 0\}$
- **观测数据**：淘汰结果 + 评委分数
- **推断目标**：粉丝投票份额向量 $v = (v_1, v_2, \ldots, v_n)$

---

## 📁 文件结构

```
q1_mcmc/
├── __init__.py          # 包初始化，导出主要类
├── config.py            # 配置参数（MCMC、路径、过滤）
├── scoring.py           # 评分与约束计算模块
├── sampler.py           # MCMC采样器（MH算法核心）
├── engine.py            # 推断引擎（数据加载、调度）
├── diagnostics.py       # 诊断与可视化
├── main.py              # 主启动器（命令行入口）
├── requirements.txt     # 依赖列表
└── 使用说明.md          # 本文档
```

---

## 🚀 快速开始


### 2. 运行推断

**方式A：双击批处理脚本**
```
双击 run_q1_mcmc.bat
```

**方式B：命令行运行**
```bash
# 完整推断（所有赛季，约10-30分钟）
python q1_mcmc/main.py

# 快速测试（前5个赛季）
python q1_mcmc/main.py --seasons 1-5 --n-samples 1000 --burn-in 500

# 详细输出
python q1_mcmc/main.py -v
```

---

## ⚙️ 配置参数说明

### 命令行参数

| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--input` | `-i` | `outputs/dwts_long_clean.csv` | 输入数据文件 |
| `--output` | `-o` | `outputs/q1_mcmc` | 输出目录 |
| `--n-samples` | `-n` | `5000` | 保留的有效样本数 |
| `--burn-in` | `-b` | `2000` | 预热期样本数（丢弃） |
| `--thin` | `-t` | `2` | 稀疏采样间隔 |
| `--lambda-percent` | - | `50.0` | 百分比制（S3-27）的软约束惩罚强度 |
| `--lambda-rank` | - | `3.0` | 排名制（S1-2, S28+）的软约束惩罚强度 |
| `--proposal-scale` | - | `100.0` | 提议分布浓度缩放 κ |
| `--prior-alpha` | - | `1.0` | Dirichlet先验浓度 α |
| `--hard-constraint` | - | `False` | 使用硬约束模式 |
| `--no-judge-save` | - | `False` | 禁用评委救人机制 |
| `--seasons` | - | 全部 | 赛季范围，如 `1-34` |
| `--exclude-seasons` | - | 空 | 排除赛季（逗号分隔），例如 `15` |
| `--n-jobs` | `-j` | `CPU核心数-1` | 并行进程数（设为 1 等价串行） |
| `--no-parallel` | - | `False` | 禁用并行，强制串行模式 |
| `--seed` | - | `42` | 随机种子 |
| `--no-plots` | - | `False` | 不生成可视化图表 |
| `--verbose` | `-v` | `False` | 详细输出 |

### 关键参数解释

#### `--n-samples`（样本数）
- 推荐值：3000-10000
- 越大估计越精确，但耗时越长
- 快速测试可用 500-1000

#### `--lambda-percent` / `--lambda-rank`（惩罚强度）
- 控制软约束的严格程度（值越大越“硬”）
- 由于 percent 与 rank 的违约值量纲不同（percent 约 0.0x，rank 为整数 1,2,...），默认使用两套 λ：
  - 百分比制：`--lambda-percent`（默认 50）
  - 排名制：`--lambda-rank`（默认 3）
- 如需完全统一的 λ，可将两个参数同时设为同一个值

#### 快速调参建议（Acceptance Rate）
- 如果排名制赛季接受率极低（< 5%）：通常是 `--lambda-rank` 太大，约束过硬
- 如果接受率过高（> 80%）：通常是 `--lambda-rank` 太小，约束不够
- 一个经验目标：两类赛季的接受率都尽量落在 20%~40% 区间

#### `--prior-alpha`（先验浓度）
- `α = 1.0`：均匀先验（最大熵，无偏好）
- `α > 1`：偏好均匀分布的投票
- `α < 1`：偏好稀疏分布（某些选手票数极高）

#### `-j / --n-jobs`（并行进程数）
- 默认值为 `CPU核心数-1`（例如 16 核机器默认 15），用于跨赛季并行加速
- 推荐值：4-8（通常能兼顾速度与电脑可用性）
- 设为 `1` 等价于串行（也可直接用 `--no-parallel`）

#### `--no-parallel`（禁用并行）
- 用于调试或排查 Windows 下的多进程兼容问题
- 如果你在并行模式遇到卡住/报错，可先用该选项确认串行可稳定运行

---

## 📤 输出文件说明

运行完成后，在 `outputs/q1_mcmc/` 目录下生成以下文件：

### 1. `fan_vote_estimates_long.csv`（长格式结果）

每行代表一个选手在某周的粉丝投票估计。

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `season` | int | 赛季号 |
| `week` | int | 周次 |
| `celebrity_name` | str | 明星选手姓名 |
| `combine_method` | str | 结合方法：`percent`（百分比制）或 `rank`（排名制） |
| `is_finale` | bool | 是否为决赛周 |
| `is_eliminated` | bool | 本周是否被淘汰 |
| `fan_vote_mean` | float | **粉丝投票份额后验均值**（核心输出） |
| `fan_vote_std` | float | 粉丝投票份额后验标准差 |
| `fan_vote_ci_lower` | float | 95% 可信区间下界（2.5%分位数） |
| `fan_vote_ci_upper` | float | 95% 可信区间上界（97.5%分位数） |
| `snr` | float | **信噪比 SNR = μ/σ**（不归一化），越大表示估计越稳定 |
| `ci_width` | float | 95% 可信区间宽度 Δ = Q97.5 - Q2.5 |
| `ppc_consistency` | float | PPC一致性（后验预测检验），满足约束的样本比例 |
| `hit_rate` | float | Hit Rate@K 命中率（定义见下文），只在存在淘汰的周有效 |
| `elimination_count` | int | 当周实际淘汰人数 K |
| `mean_violation` | float | 平均违约程度（0表示完全满足约束） |
| `acceptance_rate` | float | MCMC 接受率 |
| `converged` | bool | 是否收敛 |

#### 核心变量详解

**`fan_vote_mean`（粉丝投票份额）**
- 取值范围：[0, 1]
- 含义：该选手在本周获得的粉丝票数占总票数的比例
- 所有选手的 `fan_vote_mean` 之和约为 1

**`snr`（信噪比 SNR）**
$$\mathrm{SNR} = \frac{\mu}{\sigma}$$
- 取值范围：$[0, +\infty)$
- `SNR` 越大：后验均值相对波动越小，估计越稳定
- `SNR` 越小：不确定性更大（$\sigma$ 相对更大）
- 可视化热力图默认使用 **对数尺度**：$\log_{10}(1+\mathrm{SNR})$，避免极端值压缩颜色差异

**`ppc_consistency`（PPC一致性）**
$$\text{PPC} = \frac{1}{S} \sum_{s=1}^{S} \mathbb{I}(v^{(s)} \text{满足淘汰约束})$$
- 取值范围：[0, 1]
- 含义：后验样本中满足淘汰结果的比例
- `PPC ≈ 1`：模型与观测数据高度一致
- `PPC < 0.95`：可能存在异常情况（如争议性淘汰）

### Hit Rate 指标

Hit Rate 直接衡量“模型预测的淘汰名单”与真实淘汰结果的吻合程度，写在 `hit_rate` 列中。

#### 2.1 基础 Hit Rate (Hit Rate@K)

- 若本周实际淘汰了 $K$ 名选手，则把模型预测的 **综合得分**（评委 + 粉丝）最差的 $K$ 名视作“预测淘汰集合”。
- $$\text{Hit Rate} = \frac{\lvert \text{实际淘汰集合} \cap \text{预测淘汰集合} \rvert}{K}$$
- **取值范围**：$[0, 1]$
  - 1.0 = 完全命中
  - 0.5 = 例如淘汰 2 人，仅命中 1 人

#### 2.2 评委救人修正 (Judge's Save Hit Rate)

- 适用于 **S28+ 且启用 `judge_save`** 的周次
- 规则：虽然只淘汰 1 人（$K=1$），但只要该选手落在模型预测的 **Bottom-2** 中，即视为命中
- **并列处理**：若存在并列导致边界模糊，采用宽松策略——只要并列集合包含实际淘汰者，即认定命中

---

### 2. `fan_vote_estimates_wide.csv`（宽格式结果）

每行代表一个选手的所有周粉丝投票估计。

| 变量名 | 说明 |
|--------|------|
| `season` | 赛季号 |
| `celebrity_name` | 明星选手姓名 |
| `week1_fan_vote` | 第1周粉丝投票份额 |
| `week2_fan_vote` | 第2周粉丝投票份额 |
| ... | ... |
| `weekN_fan_vote` | 第N周粉丝投票份额 |

---

### 3. `inference_summary.json`（汇总统计）

```json
{
  "total_seasons": 34,           // 推断的赛季数
  "total_weeks_inferred": 280,   // 推断的周数
  "converged_weeks": 280,        // 收敛的周数
  "convergence_rate": 1.0,       // 收敛率
  "mean_ppc_consistency": 0.98,  // 平均PPC一致性
  "std_ppc_consistency": 0.05,   // PPC标准差
  "mean_hit_rate": 0.85,         // 平均 Hit Rate@K
  "std_hit_rate": 0.12,          // Hit Rate 标准差
  "mean_acceptance_rate": 0.35,  // 平均接受率
  "config": {                    // 使用的配置
    "n_samples": 5000,
    "burn_in": 2000,
    "thin": 2,
    "violation_lambda_percent": 50.0,
    "violation_lambda_rank": 3.0,
    "soft_elimination": true
  }
}
```

---

### 4. `diagnostic_report.txt`（诊断报告）

文本格式的诊断报告，包含：
- 总体统计
- 收敛情况
- PPC一致性分布
- Hit Rate 命中率统计
- 接受率分布
- SNR（信噪比）分布

---

### 5. 可视化图表（PNG）

| 文件名 | 说明 |
|--------|------|
| `ppc_summary.png` | 各赛季 PPC 一致性柱状图 |
| `certainty_heatmap_sX.png` | 第X赛季 SNR 热力图（默认绘制 $\log_{10}(1+\mathrm{SNR})$） |

---

## 📊 结果解读指南

### 1. 检查推断质量

```python
import pandas as pd

df = pd.read_csv('outputs/q1_mcmc/fan_vote_estimates_long.csv')

# 检查PPC一致性
print(f"平均PPC: {df['ppc_consistency'].mean():.3f}")
print(f"PPC < 0.9 的周: {(df.groupby(['season','week'])['ppc_consistency'].first() < 0.9).sum()}")

# 检查 SNR（信噪比）
print(f"平均SNR: {df['snr'].mean():.3f}")

# 检查 Hit Rate（按周去重）
weekly_hit = df.groupby(['season','week'])['hit_rate'].first().dropna()
print(f"平均Hit Rate: {weekly_hit.mean():.3f}")
print(f"Hit Rate < 0.5 的周: {(weekly_hit < 0.5).sum()}")
```

### 2. 查看特定选手的粉丝票

```python
# 查看 Bobby Bones (S27) 的粉丝票估计
bobby = df[(df['celebrity_name'] == 'Bobby Bones') & (df['season'] == 27)]
print(bobby[['week', 'fan_vote_mean', 'fan_vote_ci_lower', 'fan_vote_ci_upper']])
```

### 3. 比较被淘汰者与存活者

```python
# 比较每周被淘汰者与存活者的粉丝票
eliminated = df[df['is_eliminated'] == True]['fan_vote_mean'].mean()
survived = df[df['is_eliminated'] == False]['fan_vote_mean'].mean()
print(f"被淘汰者平均粉丝票: {eliminated:.3f}")
print(f"存活者平均粉丝票: {survived:.3f}")
```

---

## ⚠️ 注意事项

1. **第15赛季（全明星 All-Stars）**：选手构成/赛季节奏更特殊；如你希望与常规赛季同口径对比，可用 `--exclude-seasons 15` 手动排除
2. **决赛周处理**：使用链式排名约束而非淘汰约束
3. **评委救人（S28+）**：被淘汰者只需在 bottom-2 中
4. **无淘汰周**：自动跳过，不进行推断
5. **收敛检查**：如果 `converged=False`，结果不可靠

---

## 🔧 常见问题

### Q1: 推断时间太长？
- 减少 `--n-samples` 至 1000-2000
- 增大 `--thin` 至 5
- 限制 `--seasons` 范围

### Q2: PPC一致性很低？
- 可能是争议性淘汰（如 Bobby Bones）
- 百分比制赛季：可尝试增大 `--lambda-percent`
- 排名制赛季：可先尝试调小/调大 `--lambda-rank`，并观察接受率是否落在 20%~40%
- 检查数据是否有异常

### Q3: 接受率太低/太高？
- 理想范围：0.20-0.40
- 太低：减小 `--proposal-scale`
- 太高：增大 `--proposal-scale`

---

## 📚 数学原理

### 后验分布
$$P(v \mid \text{淘汰结果}) \propto \text{Dirichlet}(v; \alpha) \times \exp(-\lambda \cdot V(v))$$

### 违约函数（百分比制）
$$V(v) = \sum_{e \in \text{被淘汰者}} \max(0, \text{Total\%}_e - \text{阈值})$$

### 信噪比（SNR）
$$\mathrm{SNR}_i = \frac{\mu_i}{\sigma_i}$$

### 热力图对数尺度（可视化）
$$\log_{10}(1+\mathrm{SNR}_i)$$

---

## 📞 版本信息

- **版本**：1.0.0
- **日期**：2026-01-31
- **作者**：MCM Team
